{% extends 'adminbase.html' %}
{% load static %}

{% block title %}
    <title>Admin - {% if product %}Edit Product{% else %}Add Product{% endif %}</title>
{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/products/add_product.css' %}">
{% endblock %}

{% block content %}
<div class="form-container">
    <div class="form-header">
        <a href="{% url "admin_products" %}" class="back-link" title="Back to products">
            <i class="fa-solid fa-arrow-left"></i>
        </a>
        <div>
            <h2>{% if product %}Edit Product{% else %}Add Product{% endif %}</h2>
            <p>{% if product %}Update the product listing{% else %}Create a new product listing{% endif %}</p>
        </div>
    </div>

    {% if product_form.non_field_errors or formset.non_field_errors or formset_images.non_field_errors %}
        <div class="form-errors alert alert-danger">
            {{ product_form.non_field_errors }}
            {{ formset.non_field_errors }}
            {{ formset_images.non_field_errors }}
        </div>
    {% endif %}

    <form action="" method="POST" enctype="multipart/form-data" class="product-form" id="product-form">
        {% csrf_token %}

        <div class="form-main">
            <div class="form-left">
                <div class="form-group">
                    <label for="{{ product_form.name.id_for_label }}">Product Name</label>
                    {{ product_form.name }}
                    {{ product_form.name.errors }}
                </div>

                <div class="form-group">
                    <label for="{{ product_form.category.id_for_label }}">Category</label>
                    {{ product_form.category }}
                    {{ product_form.category.errors }}
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="{{ product_form.base_price.id_for_label }}">Base Price (₹)</label>
                        {{ product_form.base_price }}
                        {{ product_form.base_price.errors }}
                    </div>
                    <div class="form-group">
                        <label for="{{ product_form.offer_price.id_for_label }}">Offer Price (₹)</label>
                        {{ product_form.offer_price }}
                        {{ product_form.offer_price.errors }}
                    </div>
                </div>

                <div class="form-group">
                    <label for="{{ product_form.description.id_for_label }}">Description</label>
                    {{ product_form.description }}
                    {{ product_form.description.errors }}
                </div>
            </div>

            <div class="form-right">
                <div class="form-group card-style">
                    <label for="{{ product_form.image.id_for_label }}">Main Product Image</label>

                    {% if product and product.image %}
                        <div class="current-image-preview">
                            <img src="{{ product.image.url }}" alt="{{ product.alt_text|default:product.name }}" style="max-width:100%; height:auto; border-radius:8px; margin-bottom:10px;">
                            <p style="font-size:0.8rem; color:#666;">Current image</p>
                        </div>
                    {% endif %}

                    {{ product_form.image }}
                    {{ product_form.image.errors }}
                </div>

                <div class="form-group card-style">
                    <label>Product Flags</label>
                    <div class="checkbox-group"> 
                        {{ product_form.is_featured }}
                        <label for="{{ product_form.is_featured.id_for_label }}">Is Featured</label>
                    </div>
                    <div class="checkbox-group">
                        {{ product_form.is_selective }}
                        <label for="{{ product_form.is_selective.id_for_label }}">Is Selective</label>
                    </div>
                    <div class="checkbox-group">
                        {{ product_form.is_most_demanded }}
                        <label for="{{ product_form.is_most_demanded.id_for_label }}">Is Most Demanded</label>
                    </div>
                    <div class="checkbox-group">
                        {{ product_form.is_active }}
                        <label for="{{ product_form.is_active.id_for_label }}">Is Active</label>
                    </div>
                </div>
            </div>
        </div>

        <div class="dynamic-section variants-section">
            <h3>Product Variants</h3>
            <p>Add sizes and stock for each variant.</p>

            {{ formset.management_form }}

            <div id="variants-container" class="dynamic-rows-container">
                {% for form in formset %}
                <div class="dynamic-row">
                    <div style="display: none;">
                        {{ form.id }}
                        {{ form.DELETE }}
                    </div>
                    <div class="form-group">
                        <label>Size</label>
                        {{ form.size }}
                        {{ form.size.errors }}
                    </div>
                    <div class="form-group">
                        <label>Stock</label>
                        {{ form.stock }}
                        {{ form.stock.errors }}
                    </div>
                    <button type="button" class="btn-remove-row" title="Remove variant">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                </div>
                {% endfor %}
            </div>

            <button type="button" id="add-variant-btn" class="btn btn-secondary">
                <i class="fa-solid fa-plus"></i> Add Variant
            </button>
        </div>

        <div class="dynamic-section gallery-section">
            <h3>Product Gallery Images</h3>
            <p>Add additional images for the product gallery.</p>

            {{ formset_images.management_form }}

            <div id="gallery-container" class="dynamic-rows-container">
                {% for form in formset_images %}
                <div class="dynamic-row">
                    <div style="display: none;">
                        {{ form.id }}
                        {{ form.DELETE }}
                    </div>
                    <div class="form-group" style="flex: 2;">
                        <label>Image File</label>
                        {{ form.image }}
                        {{ form.image.errors }}
                        {% if form.instance.image %}
                            <div style="margin-top:8px;">
                                <img src="{{ form.instance.image.url }}" height="50" alt="Current gallery image">
                            </div>
                        {% endif %}
                    </div>
                    <div class="form-group" style="flex: 3;">
                        <label>Alt Text (Optional)</label>
                        {{ form.alt_text }}
                        {{ form.alt_text.errors }}
                    </div>
                    <button type="button" class="btn-remove-row" title="Remove image">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                </div>
                {% endfor %}
            </div>

            <button type="button" id="add-image-btn" class="btn btn-secondary">
                <i class="fa-solid fa-plus"></i> Add Image
            </button>
        </div>

        <div class="form-footer">
            <a href="{% url "admin_products" %}" class="btn btn-cancel">Cancel</a>
            <button type="submit" class="btn btn-save">
                {% if product %}Update Product{% else %}Save Product{% endif %}
            </button>
        </div>
    </form>
</div>

{# TEMPLATES FOR DYNAMIC ROWS #}
<template id="variant-empty-form">
    {{ formset.empty_form }}
</template>

<template id="image-empty-form">
    {{ formset_images.empty_form }}
</template>
{% endblock %}

{% block extraJs %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const variantTemplate = document.getElementById('variant-empty-form').innerHTML;
    const imageTemplate = document.getElementById('image-empty-form').innerHTML;

    function addFormRow(containerId, templateHtml, prefix) {
        const container = document.getElementById(containerId);
        const totalForms = document.querySelector(`#id_${prefix}-TOTAL_FORMS`);
        const formIdx = parseInt(totalForms.value);

        let newFormHtml = templateHtml.replace(/__prefix__/g, formIdx);
        newFormHtml = newFormHtml.replace(/<label[^>]*>.*?<\/label>/g, ''); // Remove labels from empty form

        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = newFormHtml;
        const newRow = tempDiv.firstElementChild;

        // Wrap in dynamic-row
        const rowWrapper = document.createElement('div');
        rowWrapper.className = 'dynamic-row';
        rowWrapper.appendChild(newRow);

        // Add remove button
        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.className = 'btn-remove-row';
        removeBtn.title = prefix === 'variants' ? 'Remove variant' : 'Remove image';
        removeBtn.innerHTML = '<i class="fa-solid fa-trash"></i>';
        rowWrapper.appendChild(removeBtn);

        // Add hidden DELETE
        const deleteInput = document.createElement('div');
        deleteInput.style.display = 'none';
        deleteInput.innerHTML = `<input type="checkbox" name="${prefix}-${formIdx}-DELETE" id="id_${prefix}-${formIdx}-DELETE">`;
        rowWrapper.appendChild(deleteInput);

        container.appendChild(rowWrapper);
        totalForms.value = formIdx + 1;
    }

    document.getElementById('add-variant-btn').addEventListener('click', () => {
        addFormRow('variants-container', variantTemplate, 'variants');
    });

    document.getElementById('add-image-btn').addEventListener('click', () => {
        addFormRow('gallery-container', imageTemplate, 'images');
    });

    // Remove row
    document.getElementById('product-form').addEventListener('click', function(e) {
        const btn = e.target.closest('.btn-remove-row');
        if (!btn) return;

        const row = btn.closest('.dynamic-row');
        const deleteCheckbox = row.querySelector('input[type="checkbox"][name$="-DELETE"]');
        const idInput = row.querySelector('input[id^="id_"][id$="-id"]');

        if (deleteCheckbox && idInput && idInput.value) {
            // Existing object → mark for deletion
            deleteCheckbox.checked = true;
            row.style.display = 'none';
        } else {
            // New form → just remove
            row.remove();
            // Update TOTAL_FORMS
            const prefix = row.closest('.dynamic-rows-container').id.includes('variant') ? 'variants' : 'images';
            const total = document.querySelector(`#id_${prefix}-TOTAL_FORMS`);
            total.value = parseInt(total.value) - 1;
        }
    });

    // Main image preview
    // FIXED: Used the correct dynamic ID from the form
    const mainImageInput = document.getElementById('{{ product_form.image.id_for_label }}'); 
    if (mainImageInput) {
        mainImageInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            let previewContainer = mainImageInput.closest('.form-group').querySelector('.image-preview');
            if (!previewContainer) {
                previewContainer = document.createElement('div');
                previewContainer.className = 'image-preview';
                previewContainer.innerHTML = '<img style="max-width:100%; height:auto; border-radius:8px; margin:10px 0;">';
                mainImageInput.before(previewContainer);
            }

            const reader = new FileReader();
            reader.onload = (e) => previewContainer.querySelector('img').src = e.target.result;
            reader.readDataURL(file);
        });
    }
});
</script>
{% endblock %}